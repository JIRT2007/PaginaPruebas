<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="stylesheet" href="../RECURSOS/CSS/style_calculadora.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <title>Calculadora</title>

  <style>
    .tablero {
      background-image: url("../RECURSOS/IMAGENES/SpriteTablero.png");
      background-size: cover;
      background-repeat: no-repeat;
      background-position: center;
      width: 70%;
      height: 80%;
      border: 7px solid rgba(255, 255, 255, 1);
    }

    body::before {
      content: "";
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-image: url("../RECURSOS/IMAGENES/fondoInicio.png");
      background-size: cover;
      background-repeat: no-repeat;
      background-position: center;
      filter: blur(8px) brightness(0.7);
      z-index: -1;
    }

    .icon-btn:hover {
      background-color: #45a049;
      transform: scale(1.1);
    }
  </style>
</head>

<body>
  <div class="tablero" id="tablero"> 
    <div class="region region-top-left dropzone"></div>
    <div class="region region-top-right dropzone"></div>
    <div class="region region-middle-left dropzone"></div>
    <div class="region region-middle-right dropzone"></div>
    <div class="region region-bottom-left dropzone"></div>
    <div class="region region-bottom-right dropzone"></div>
    <div class="region region-center dropzone"></div>
  </div>

  <div class="tab" id="TomaDinosaurios">
    <div id="zona-dinos"></div>
    <span id="turno-info" style="color:black; margin-left:10px;">Tablero del jugador: 1</span>

    <button class="CalculoF" id="btn-calcular">
      <label>Calcular puntaje</label>
      <i class="fa-solid fa-flag-checkered"></i>
    </button>

    <button class="CambioTurno" id="btn-cambiar-turno">
      <label>Siguiente jugador</label>
      <i class="fa-solid fa-users"></i>
    </button>
   
    <button class="Salir" onclick="window.location.href='../BACK/logout.php'">
      <label>Volver al inicio</label>
      <i class="fa-solid fa-right-from-bracket"></i>
    </button>
  </div>

  <script>
  document.addEventListener("DOMContentLoaded", () => {
    const dinosContainer = document.getElementById("zona-dinos");
    const btnCambiarTurno = document.getElementById("btn-cambiar-turno");
    const btnCalcular = document.getElementById("btn-calcular");
    const turnoInfo = document.getElementById("turno-info");

    const maxJugadores = 4;
    let turnoActual = 1;

    let tableros = Array.from({ length: maxJugadores }, () => ({
      "region-top-left": [],
      "region-top-right": [],
      "region-middle-left": [],
      "region-middle-right": [],
      "region-bottom-left": [],
      "region-bottom-right": [],
      "region-center": []
    }));

    const dinos = [
      { nombre: "T-Rex", img: "DinoRojoSprite.png" },
      { nombre: "Triceratops", img: "DinoAmarilloSprite.png" },
      { nombre: "Stegosaurus", img: "DinoVerdeSprite.png" },
      { nombre: "Velociraptor", img: "DinoVioletaSprite.png" },
      { nombre: "Brachiosaurus", img: "DinoAzulSprite.png" },
      { nombre: "Ankylosaurus", img: "DinoNaranjaSprite.png" }
    ];

    const limitePorZona = {
      "region region-top-left dropzone": 6,
      "region region-top-right dropzone": 1,
      "region region-middle-left dropzone": 3,
      "region region-middle-right dropzone": 6,
      "region region-bottom-left dropzone": 12,
      "region region-bottom-right dropzone": 1,
      "region region-center dropzone": 60
    };

    function agregarEventosArrastre(elem) {
      elem.addEventListener("dragstart", (e) => {
        e.dataTransfer.setData("dino-img", elem.querySelector("img").src);
        e.dataTransfer.effectAllowed = "move";
      });

      elem.addEventListener("contextmenu", (e) => {
        e.preventDefault();
        elem.remove();
      });

      let lastTap = 0;
      elem.addEventListener("touchstart", () => {
        const currentTime = new Date().getTime();
        if (currentTime - lastTap < 300) elem.remove();
        lastTap = currentTime;
      });
    }

    function generarDinos() {
      dinosContainer.innerHTML = "";
      dinos.forEach((dino) => {
        const dinoDiv = document.createElement("div");
        dinoDiv.className = "draggable";
        dinoDiv.draggable = true;
        dinoDiv.innerHTML = `<img src="../RECURSOS/IMAGENES/${dino.img}" alt="${dino.nombre}">`;
        agregarEventosArrastre(dinoDiv);
        dinosContainer.appendChild(dinoDiv);
      });
    }

    function guardarTablero(jugador) {
      document.querySelectorAll(".dropzone").forEach((zone) => {
        const id = zone.classList[1];
        const dinos = [];
        zone.querySelectorAll("img").forEach((img) => dinos.push(img.src));
        tableros[jugador - 1][id] = dinos;
      });
    }

    function cargarTablero(jugador) {
      document.querySelectorAll(".dropzone").forEach((zone) => {
        const id = zone.classList[1];
        zone.innerHTML = "";
        tableros[jugador - 1][id].forEach((src) => {
          const dinoDiv = document.createElement("div");
          dinoDiv.className = "draggable";
          dinoDiv.draggable = true;
          dinoDiv.innerHTML = `<img src="${src}" alt="Dino">`;
          agregarEventosArrastre(dinoDiv);
          zone.appendChild(dinoDiv);
        });
      });
    }

    document.querySelectorAll(".dropzone").forEach((zone) => {
      zone.addEventListener("dragover", (e) => {
        e.preventDefault();
        zone.style.backgroundColor = "rgba(255,255,255,0.1)";
      });

      zone.addEventListener("dragleave", () => {
        zone.style.backgroundColor = "transparent";
      });

      zone.addEventListener("drop", (e) => {
        e.preventDefault();
        zone.style.backgroundColor = "transparent";

        const totalDinos = document.querySelectorAll(".dropzone img").length;
        if (totalDinos >= 12) {
          alert("El tablero ya cuenta con el límite de 12 dinosaurios");
          return;
        }

        const dinoImg = e.dataTransfer.getData("dino-img");
        if (dinoImg) {
          const idZona = zone.className;
          const limite = limitePorZona[idZona];
          const cantidadActual = zone.querySelectorAll("img").length;

          if (cantidadActual >= limite) {
            alert("Este recinto alcanzó el límite de dinosaurios admitidos");
            return;
          }

          if (zone.classList.contains("region-top-left")) {
            const imgs = zone.querySelectorAll("img");
            if (imgs.length > 0 && imgs[0].src !== dinoImg) {
              alert("Solo puedes colocar dinosaurios del mismo tipo en esta zona");
              return;
            }
          }

          if (zone.classList.contains("region-middle-right")) {
            const imgs = zone.querySelectorAll("img");
            if (Array.from(imgs).some((img) => img.src === dinoImg)) {
              alert("Solo puedes colocar dinosaurios diferentes en esta zona");
              return;
            }
          }

          const dinoDiv = document.createElement("div");
          dinoDiv.className = "draggable";
          dinoDiv.draggable = true;
          dinoDiv.innerHTML = `<img src="${dinoImg}" alt="Dino">`;
          agregarEventosArrastre(dinoDiv);
          zone.appendChild(dinoDiv);
        }
      });
    });

    btnCambiarTurno.addEventListener("click", () => {
      guardarTablero(turnoActual);
      if (turnoActual < maxJugadores) {
        turnoActual++;
        turnoInfo.textContent = `Tablero del jugador: ${turnoActual}`;
        cargarTablero(turnoActual);
        generarDinos();
      } else {
        alert("Ya jugaron todos los jugadores.");
      }
    });

    // Cálculo de puntos según las reglas
    function calcularPuntaje(jugador) {
      const tablero = tableros[jugador - 1];
      let puntos = 0;

      // Función auxiliar para obtener nombre del dino desde la ruta
      const getNombre = (src) => src.split("/").pop().replace("Sprite.png", "").replace("Dino", "");

      // Regla region-top-left 
      const topLeft = tablero["region-top-left"].length;
      const puntosTopLeft = [0, 2, 4, 8, 12, 18, 24];
      puntos += puntosTopLeft[topLeft] || 0;

      // Regla region-middle-left 
      if (tablero["region-middle-left"].length === 3) puntos += 7;

      // Regla region-bottom-left 
      const pares = Math.floor(tablero["region-bottom-left"].length / 2);
      puntos += pares * 5;

      // Regla region-center
      puntos += tablero["region-center"].length;

      // Regla region-top-right
      const dinoTopRight = tablero["region-top-right"][0];
      if (dinoTopRight) {
        const nombre = getNombre(dinoTopRight);
        const totalJugador = Object.values(tablero).flat().filter((src) => getNombre(src) === nombre).length;

        let esMayor = true;
        for (let i = 0; i < maxJugadores; i++) {
          if (i === jugador - 1) continue;
          const totalOtro = Object.values(tableros[i]).flat().filter((src) => getNombre(src) === nombre).length;
          if (totalOtro > totalJugador) {
            esMayor = false;
            break;
          }
        }
        if (esMayor && totalJugador > 0) puntos += 7;
      }

      // Regla region-middle-right
      const midRight = tablero["region-middle-right"].length;
      const puntosMidRight = [0, 1, 3, 6, 10, 15, 21];
      puntos += puntosMidRight[midRight] || 0;

      // Regla region-bottom-right
      const todos = Object.values(tablero).flat().map(getNombre);
      const unicos = new Set(todos);
      if (todos.length === unicos.size && todos.length > 0) puntos += 7;

      // Regla T-Rex bonus
      puntos += todos.filter((n) => n === "Rojo").length; // DinoRojoSprite

      return puntos;
    }

    btnCalcular.addEventListener("click", () => {
      guardarTablero(turnoActual);
      const total = calcularPuntaje(turnoActual);
      alert(`Puntaje del jugador ${turnoActual}: ${total}`);
    });

    generarDinos();
  });
  </script>
</body>
</html>
