<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="stylesheet" href="../RECURSOS/CSS/style_calculadora.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <title>Calculadora</title>

  <style>
    .tablero {
      background-image: url("../RECURSOS/IMAGENES/SpriteTablero.png");
      background-size: cover;
      background-repeat: no-repeat;
      background-position: center;
      width: 70%;
      height: 75%;
      border: 7px solid rgba(255, 255, 255, 1);
    }

    body::before {
      content: "";
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-image: url("../RECURSOS/IMAGENES/fondoInicio.png");
      background-size: cover;
      background-repeat: no-repeat;
      background-position: center;
      filter: blur(8px) brightness(0.7);
      z-index: -1;
    }
    .CambioTurno, .Salir {
      border-radius: 15px !important;
      backdrop-filter: blur(10px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
      transition: all 0.3s ease;
    }

  </style>
</head>

<body>
  <div class="tablero" id="tablero"> 
    <div class="region region-top-left dropzone"></div>
    <div class="region region-top-right dropzone"></div>
    <div class="region region-middle-left dropzone"></div>
    <div class="region region-middle-right dropzone"></div>
    <div class="region region-bottom-left dropzone"></div>
    <div class="region region-bottom-right dropzone"></div>
    <div class="region region-center dropzone"></div>
  </div>

  <div class="tab" id="TomaDinosaurios">
    <div id="zona-dinos"></div>
    <span id="turno-info" style="color:black; margin-left:10px; ">Tablero del jugador: 1</span>

    <button class="CambioTurno" id="btn-cambiar-turno">
      <label>Siguiente jugador</label>
      <i class="fa-solid fa-users"></i>
    </button>
   
    <button class="Salir" onclick="window.location.href='../BACK/logout.php'">
      <label>Volver al inicio</label>
      <i class="fa-solid fa-right-from-bracket"></i>
    </button>
  </div>

  <!-- Sistema de puntajes -->
  <div class="score-system" id="score-system">
    <h3 style="color: white; text-align: center; margin: 10px 0; text-shadow: 2px 2px 4px rgba(0,0,0,0.8);">Puntajes de Jugadores</h3>
    <div class="scores-container" id="scores-container">
      <!-- Los puntajes se mostrarán aquí dinámicamente -->
    </div>
    <div class="leader-display" id="leader-display">
      <span style="color: #FFD700; font-weight: bold; text-shadow: 2px 2px 4px rgba(0,0,0,0.8);">Líder: </span>
      <span id="leader-name" style="color: #FFD700; font-weight: bold; text-shadow: 2px 2px 4px rgba(0,0,0,0.8);">Ninguno</span>
    </div>
  </div>

  <script>
  document.addEventListener("DOMContentLoaded", () => {
    const dinosContainer = document.getElementById("zona-dinos");
    const btnCambiarTurno = document.getElementById("btn-cambiar-turno");
    const turnoInfo = document.getElementById("turno-info");

    const maxJugadores = 5;
    let turnoActual = 1;
    
    // Sistema de puntajes
    let puntajes = Array.from({ length: maxJugadores }, () => 0);

    let tableros = Array.from({ length: maxJugadores }, () => ({
      "region-top-left": [],
      "region-top-right": [],
      "region-middle-left": [],
      "region-middle-right": [],
      "region-bottom-left": [],
      "region-bottom-right": [],
      "region-center": []
    }));

    const dinos = [
      { nombre: "T-Rex", img: "DinoRojoSprite.png" },
      { nombre: "Triceratops", img: "DinoAmarilloSprite.png" },
      { nombre: "Stegosaurus", img: "DinoVerdeSprite.png" },
      { nombre: "Velociraptor", img: "DinoVioletaSprite.png" },
      { nombre: "Brachiosaurus", img: "DinoAzulSprite.png" },
      { nombre: "Ankylosaurus", img: "DinoNaranjaSprite.png" }
    ];

    const limitePorZona = {
      "region region-top-left dropzone": 6,
      "region region-top-right dropzone": 1,
      "region region-middle-left dropzone": 3,
      "region region-middle-right dropzone": 6,
      "region region-bottom-left dropzone": 12,
      "region region-bottom-right dropzone": 1,
      "region region-center dropzone": 60
    };

    function agregarEventosArrastre(elem) {
      elem.addEventListener("dragstart", (e) => {
        e.dataTransfer.setData("dino-img", elem.querySelector("img").src);
        e.dataTransfer.effectAllowed = "move";
      });

      elem.addEventListener("contextmenu", (e) => {
        e.preventDefault();
        elem.remove();
        // Verificar si se debe recalcular puntajes después de eliminar
        setTimeout(() => {
          const totalDinos = document.querySelectorAll(".dropzone img").length;
          if (totalDinos < 12) {
            recalcularTodosLosPuntajes();
          }
        }, 100);
      });

      let lastTap = 0;
      elem.addEventListener("touchstart", () => {
        const currentTime = new Date().getTime();
        if (currentTime - lastTap < 300) {
          elem.remove();
          // Verificar si se debe recalcular puntajes después de eliminar
          setTimeout(() => {
            const totalDinos = document.querySelectorAll(".dropzone img").length;
            if (totalDinos < 12) {
              recalcularTodosLosPuntajes();
            }
          }, 100);
        }
        lastTap = currentTime;
      });
    }

    function generarDinos() {
      dinosContainer.innerHTML = "";
      dinos.forEach((dino) => {
        const dinoDiv = document.createElement("div");
        dinoDiv.className = "draggable";
        dinoDiv.draggable = true;
        dinoDiv.innerHTML = `<img src="../RECURSOS/IMAGENES/${dino.img}" alt="${dino.nombre}">`;
        agregarEventosArrastre(dinoDiv);
        dinosContainer.appendChild(dinoDiv);
      });
    }

    // Función para calcular automáticamente los puntajes del jugador actual
    function calcularPuntajesAutomaticos() {
      guardarTablero(turnoActual);
      const total = calcularPuntaje(turnoActual);
      
      // Guardar el puntaje del jugador actual
      puntajes[turnoActual - 1] = total;
      
      // Recalcular todos los puntajes para actualizar las reglas competitivas
      recalcularTodosLosPuntajes();
      
      // Mostrar mensaje de cálculo automático
      alert(`¡Tablero completo! Puntaje del jugador ${turnoActual}: ${total} puntos`);
    }

    // Función para recalcular todos los puntajes
    function recalcularTodosLosPuntajes() {
      for (let i = 0; i < maxJugadores; i++) {
        // Solo recalcular si el jugador ya tiene un tablero configurado
        const tieneDinos = Object.values(tableros[i]).flat().length > 0;
        if (tieneDinos) {
          puntajes[i] = calcularPuntaje(i + 1);
        }
      }
      actualizarPuntajes();
    }

    // Función para actualizar la visualización de puntajes
    function actualizarPuntajes() {
      const scoresContainer = document.getElementById("scores-container");
      const leaderDisplay = document.getElementById("leader-name");
      
      scoresContainer.innerHTML = "";
      
      let maxPuntaje = Math.max(...puntajes);
      let lideres = [];
      
      puntajes.forEach((puntaje, index) => {
        const playerDiv = document.createElement("div");
        playerDiv.className = "player-score";
        
        if (puntaje === maxPuntaje && maxPuntaje > 0) {
          playerDiv.classList.add("leader");
          lideres.push(`Jugador ${index + 1}`);
        }
        
        playerDiv.textContent = `Jugador ${index + 1}: ${puntaje}`;
        
        scoresContainer.appendChild(playerDiv);
      });
      
      // Actualizar el líder
      if (lideres.length === 0) {
        leaderDisplay.textContent = "Ninguno";
      } else if (lideres.length === 1) {
        leaderDisplay.textContent = lideres[0];
      } else {
        leaderDisplay.textContent = `Empate: ${lideres.join(", ")}`;
      }
    }

    function guardarTablero(jugador) {
      document.querySelectorAll(".dropzone").forEach((zone) => {
        const id = zone.classList[1];
        const dinos = [];
        zone.querySelectorAll("img").forEach((img) => dinos.push(img.src));
        tableros[jugador - 1][id] = dinos;
      });
    }

    function cargarTablero(jugador) {
      document.querySelectorAll(".dropzone").forEach((zone) => {
        const id = zone.classList[1];
        zone.innerHTML = "";
        tableros[jugador - 1][id].forEach((src) => {
          const dinoDiv = document.createElement("div");
          dinoDiv.className = "draggable";
          dinoDiv.draggable = true;
          dinoDiv.innerHTML = `<img src="${src}" alt="Dino">`;
          agregarEventosArrastre(dinoDiv);
          zone.appendChild(dinoDiv);
        });
      });
    }

    document.querySelectorAll(".dropzone").forEach((zone) => {
      zone.addEventListener("dragover", (e) => {
        e.preventDefault();
        zone.style.backgroundColor = "rgba(255,255,255,0.1)";
      });

      zone.addEventListener("dragleave", () => {
        zone.style.backgroundColor = "transparent";
      });

      zone.addEventListener("drop", (e) => {
        e.preventDefault();
        zone.style.backgroundColor = "transparent";

        const totalDinos = document.querySelectorAll(".dropzone img").length;
        if (totalDinos >= 12) {
          alert("El tablero ya cuenta con el límite de 12 dinosaurios");
          return;
        }

        const dinoImg = e.dataTransfer.getData("dino-img");
        if (dinoImg) {
          const idZona = zone.className;
          const limite = limitePorZona[idZona];
          const cantidadActual = zone.querySelectorAll("img").length;

          if (cantidadActual >= limite) {
            alert("Este recinto alcanzó el límite de dinosaurios admitidos");
            return;
          }

          if (zone.classList.contains("region-top-left")) {
            const imgs = zone.querySelectorAll("img");
            if (imgs.length > 0 && imgs[0].src !== dinoImg) {
              alert("Solo puedes colocar dinosaurios del mismo tipo en esta zona");
              return;
            }
          }

          if (zone.classList.contains("region-middle-right")) {
            const imgs = zone.querySelectorAll("img");
            if (Array.from(imgs).some((img) => img.src === dinoImg)) {
              alert("Solo puedes colocar dinosaurios diferentes en esta zona");
              return;
            }
          }

          const dinoDiv = document.createElement("div");
          dinoDiv.className = "draggable";
          dinoDiv.draggable = true;
          dinoDiv.innerHTML = `<img src="${dinoImg}" alt="Dino">`;
          agregarEventosArrastre(dinoDiv);
          zone.appendChild(dinoDiv);

          // Verificar si se alcanzó el límite de 12 dinosaurios después de agregar este
          const nuevoTotalDinos = document.querySelectorAll(".dropzone img").length;
          if (nuevoTotalDinos >= 12) {
            // Calcular puntajes automáticamente cuando se complete el tablero
            setTimeout(() => {
              calcularPuntajesAutomaticos();
            }, 100); // Pequeño delay para que se complete la animación
          }
        }
      });
    });

    btnCambiarTurno.addEventListener("click", () => {
      // Validar que el tablero actual tenga 12 dinosaurios antes de avanzar
      const totalDinos = document.querySelectorAll(".dropzone img").length;
      if (totalDinos < 12) {
        alert("Debes colocar tus 12 dinosaurios para pasar al siguiente jugador");
        return;
      }

      guardarTablero(turnoActual);
      if (turnoActual < maxJugadores) {
        turnoActual++;
        turnoInfo.textContent = `Tablero del jugador: ${turnoActual}`;
        cargarTablero(turnoActual);
        generarDinos();
        
        // Recalcular todos los puntajes para actualizar las reglas que dependen de comparaciones
        recalcularTodosLosPuntajes();
      } else {
        alert("Ya jugaron todos los jugadores.");
      }
    });

    // Cálculo de puntos según las reglas
    function calcularPuntaje(jugador) {
      const tablero = tableros[jugador - 1];
      let puntos = 0;

      // Función auxiliar para obtener nombre del dino desde la ruta
      const getNombre = (src) => src.split("/").pop().replace("Sprite.png", "").replace("Dino", "");

      // Regla region-top-left 
      const topLeft = tablero["region-top-left"].length;
      const puntosTopLeft = [0, 2, 4, 8, 12, 18, 24];
      puntos += puntosTopLeft[topLeft] || 0;

      // Regla region-middle-left 
      if (tablero["region-middle-left"].length === 3) puntos += 7;

      // Regla region-bottom-left 
      const pares = Math.floor(tablero["region-bottom-left"].length / 2);
      puntos += pares * 5;

      // Regla region-center
      puntos += tablero["region-center"].length;

      // Regla region-top-right (Rey - Mayoría entre todos los jugadores)
      const dinoTopRight = tablero["region-top-right"][0];
      if (dinoTopRight) {
        const nombre = getNombre(dinoTopRight);
        // Contar TODOS los dinosaurios de esta especie en el tablero del jugador (incluyendo el rey)
        const totalJugador = Object.values(tablero).flat().filter((src) => getNombre(src) === nombre).length;

        // Verificar si este jugador tiene la mayoría o empate de este dinosaurio entre todos los jugadores
        let tieneMayoria = true;
        for (let i = 0; i < maxJugadores; i++) {
          if (i === jugador - 1) continue; // Saltar el jugador actual
          // Contar TODOS los dinosaurios de esta especie en el tablero del otro jugador
          const totalOtro = Object.values(tableros[i]).flat().filter((src) => getNombre(src) === nombre).length;
          // Si otro jugador tiene MÁS de este dinosaurio, no tiene mayoría
          if (totalOtro > totalJugador) {
            tieneMayoria = false;
            break;
          }
        }
        
        // Solo otorgar puntos si tiene mayoría o empate (más o igual que todos los demás)
        // El rey cuenta como uno más en el total para determinar la mayoría
        if (tieneMayoria && totalJugador > 0) {
          puntos += 7;
        }
      }

      // Regla region-middle-right
      const midRight = tablero["region-middle-right"].length;
      const puntosMidRight = [0, 1, 3, 6, 10, 15, 21];
      puntos += puntosMidRight[midRight] || 0;

      // Regla region-bottom-right
      const dinoBottomRight = tablero["region-bottom-right"][0];
      if (dinoBottomRight) {
        const nombreBottomRight = getNombre(dinoBottomRight);
        // Contar cuántas veces aparece este dinosaurio en el tablero
        const aparicionesEnTablero = Object.values(tablero).flat().filter((src) => getNombre(src) === nombreBottomRight).length;
        // Solo otorgar puntos si el dinosaurio aparece exactamente 1 vez (no se repite)
        if (aparicionesEnTablero === 1) {
          puntos += 7;
        }
      }
      
      // Regla T-Rex bonus
      const todos = Object.values(tablero).flat().map(getNombre);
      puntos += todos.filter((n) => n === "Rojo").length; // DinoRojoSprite

      return puntos;
    }

    generarDinos();
    actualizarPuntajes(); // Inicializar la visualización de puntajes
  });
  </script>
</body>
</html>
